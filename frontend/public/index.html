<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>BIO SPACE AI â€“ Chat</title>
    <style>
        :root{
            --sidebar-w:320px;
            --gap:14px;
            --radius:12px;
            --btn-pad:10px 12px;
            --btn-fs:13.5px;

            --neon-cyan:#00e5ff;
            --neon-pink:#ff47ff;
            --neon-purple:#8b5cf6;
            --neon-lime:#b5ff3f;
            --brand-from: var(--neon-cyan);
            --brand-to:   var(--neon-purple);

            --t-fast:.15s;
            --t-med:.28s;
        }

        *{box-sizing:border-box}
        html,body,#app{height:100%}
        body{margin:0;font-family:system-ui,Inter,Roboto,Arial,sans-serif;overflow:auto;transition:background .35s,color .35s, filter .35s}
        body.dark{
            background:
                    radial-gradient(1000px 600px at 20% -200px, rgba(139,92,246,.12), transparent 55%),
                    radial-gradient(900px 650px at 120% 20%, rgba(0,229,255,.10), transparent 60%),
                    #060a1f;
            color:#e9eef7;
        }
        body.light{
            background:#f5f7fb; /* base sÃ³lida en claro */
            color:#0D0D0D;
        }

        #app{opacity:1;transition:opacity var(--t-med) ease}
        body.locked #app{opacity:0;pointer-events:none}

        .wrap{display:grid;grid-template-columns:var(--sidebar-w) 1fr;min-height:100vh}

        /* Sidebar fija */
        .sidebar{
            position:sticky; top:0; height:100vh;
            padding:18px 14px 86px;
            background:linear-gradient(180deg, #0a0f2c 0%, #0b1238 60%, #0f173f 100%);
            color:#eef3ff;display:flex;flex-direction:column;gap:var(--gap);overflow:hidden;
            border-right:1px solid rgba(255,255,255,.08);
            box-shadow:inset 0 0 0 1px rgba(255,255,255,.06), 0 10px 40px rgba(0,0,0,.28);
        }
        body.light .sidebar{
            background:#ffffff;
            color:#0D0D0D;border-right:1px solid rgba(0,0,0,.06);
            box-shadow:inset 0 0 0 1px rgba(0,0,0,.05), 0 10px 40px rgba(0,0,0,.06);
        }

        .brand{display:flex;align-items:center;gap:10px}
        .brand img{
            width:36px;height:36px;border-radius:12px;object-fit:cover;
            box-shadow:0 0 0 2px rgba(255,255,255,.08), 0 8px 24px rgba(139,92,246,.35);
            transition:transform var(--t-med) ease, box-shadow var(--t-med) ease;
        }
        .brand img:hover{transform:translateY(-1px) scale(1.03)}
        .brand .title{font-weight:900;letter-spacing:.35px}

        .section{display:flex;flex-direction:column;gap:10px}
        .section h3{font-size:12.5px;opacity:.9;margin:0 4px}

        .card-min{
            border:1px solid rgba(0,229,255,.25);
            background:linear-gradient(180deg, rgba(0,229,255,.08), rgba(139,92,246,.08));
            border-radius:var(--radius);padding:10px;
            box-shadow:0 0 24px rgba(0,229,255,.08) inset, 0 12px 32px rgba(0,0,0,.18);
            transition:box-shadow var(--t-med) ease, border-color var(--t-med) ease;
        }
        .card-min:focus-within{box-shadow:0 0 28px rgba(0,229,255,.16)}
        body.light .card-min{
            background:#ffffff;
            border-color:rgba(0,0,0,.10);
            box-shadow:0 8px 16px rgba(0,0,0,.04);
        }

        .card-min .row{display:flex;gap:8px}
        .card-min .row>input, .card-min .row>textarea{
            flex:1;padding:10px;border-radius:var(--radius);
            border:1px solid rgba(255,255,255,.20);
            background:rgba(4,10,30,.55);outline:none;font-size:13.5px;color:#e9f7ff;
            box-shadow:0 0 0 2px transparent;transition:border-color var(--t-fast), box-shadow var(--t-fast);
        }
        .card-min .row>input:focus, .card-min .row>textarea:focus{
            border-color:rgba(0,229,255,.75);
            box-shadow:0 0 0 2px rgba(0,229,255,.35), 0 0 22px rgba(0,229,255,.18);
        }
        body.light .card-min .row>input, body.light .card-min .row>textarea{
            background:#ffffff;border-color:rgba(0,0,0,.18);color:#0D0D0D
        }

        /* Botones */
        .btn,.toggle{
            width:100%;display:flex;align-items:center;gap:8px;justify-content:center;
            padding:var(--btn-pad);border-radius:999px;
            border:1px solid rgba(255,255,255,.14);
            background:linear-gradient(180deg, rgba(0,229,255,.12), rgba(139,92,246,.10));
            color:inherit;cursor:pointer;
            transition:transform var(--t-fast), background var(--t-fast), box-shadow var(--t-fast), border-color var(--t-fast), filter var(--t-fast);
            font-size:var(--btn-fs);
            box-shadow:0 6px 20px rgba(0,0,0,.18), inset 0 0 0 1px rgba(255,255,255,.06);
            backdrop-filter:saturate(130%);
        }
        .btn:hover,.toggle:hover{
            background:linear-gradient(180deg, rgba(0,229,255,.18), rgba(139,92,246,.16));
            box-shadow:0 10px 26px rgba(0,229,255,.18);
            border-color:rgba(0,229,255,.35);
            filter:saturate(120%);
        }
        .btn:active,.toggle:active{transform:translateY(1px) scale(.98)}
        .btn.small{padding:8px 10px;border-radius:999px;font-size:13px}
        .ghost{background:transparent;border:1px solid rgba(255,255,255,.22)}
        body.light .btn, body.light .toggle{
            background:#ffffff;
            border-color:rgba(0,0,0,.12);
            box-shadow:0 6px 14px rgba(0,0,0,.05);
        }
        body.light .ghost{border-color:rgba(0,0,0,.2)}

        /* Controles en UNA lÃ­nea */
        .section.controls{
            display:flex;
            flex-direction:row;
            align-items:center;
            gap:8px;
        }
        .icon-only span{display:none}
        #btnTheme,#btnLang,#btnReset{
            width:42px;height:42px;display:inline-flex;align-items:center;justify-content:center;font-size:18px;
            padding:0;flex:0 0 auto;
        }

        .footer{
            position:absolute;left:0;right:0;bottom:0;padding:10px 14px;border-top:1px solid rgba(255,255,255,.10);
            background:linear-gradient(180deg, rgba(0,0,0,.0), rgba(0,229,255,.08));
        }
        body.light .footer{border-top:1px solid rgba(0,0,0,.08);background:#ffffff}
        .who{display:flex;align-items:center;gap:10px;justify-content:space-between}
        .who .avatar{
            width:42px;height:42px;border-radius:50%;
            background:radial-gradient(circle at 30% 30%, rgba(0,229,255,.25), rgba(139,92,246,.18) 45%, rgba(0,0,0,.35) 46%);
            color:#0D0D0D;display:flex;align-items:center;justify-content:center;font-weight:800;overflow:hidden;
            box-shadow:0 0 0 2px rgba(0,229,255,.45), 0 8px 28px rgba(0,229,255,.25);
            border:2px solid rgba(255,255,255,.18);transition:transform var(--t-med);
        }
        .who .avatar:hover{transform:scale(1.03)}
        .who .avatar img{width:100%;height:100%;object-fit:cover;display:none}
        .who .name{font-weight:800}
        .who .role{opacity:.85;font-size:12px}

        /* Chat */
        .chat{position:relative;display:flex;flex-direction:column;min-height:100vh}
        .space-bg{
            position:absolute;inset:0;background-size:cover;background-position:center;background-attachment:fixed;
            opacity:.30;pointer-events:none;transition:opacity var(--t-med), filter var(--t-med), transform var(--t-med);
            filter:saturate(130%) contrast(105%) hue-rotate(6deg)
        }
        /* Modo claro: sin imagen de fondo, fondo sÃ³lido */
        body.light .space-bg{ display:none; }

        .chat-header{
            position:sticky;top:0;z-index:3;display:flex;align-items:center;gap:12px;padding:12px 16px;
            background:#030613;border-bottom:1px solid rgba(0,229,255,.35);
            box-shadow:0 8px 26px rgba(0,0,0,.35);
        }
        body.light .chat-header{background:#ffffff;border-bottom:1px solid rgba(0,229,255,.45);box-shadow:0 6px 20px rgba(0,0,0,.08)}
        .logo{display:flex;align-items:center;gap:10px}
        .logo img{width:40px;height:40px;border-radius:12px;object-fit:cover;box-shadow:0 8px 28px rgba(139,92,246,.35)}
        .title{font-weight:900;font-size:18px;letter-spacing:.4px}
        .ia-badge{
            display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:12px;
            border:1px solid rgba(0,229,255,.55);font-weight:900;font-size:11.5px;letter-spacing:.6px;
            background:radial-gradient(120% 180% at 20% -40%, rgba(0,229,255,.25), rgba(255,71,255,.18) 45%, rgba(0,0,0,.25) 46%);
            color:#dffbff;box-shadow:0 0 20px rgba(0,229,255,.35), inset 0 0 18px rgba(0,229,255,.15);
        }
        .ia-badge:hover{transform:translateY(-1px);box-shadow:0 0 24px rgba(0,229,255,.45)}
        body.light .ia-badge{background:#ffffff;color:#0b1535;border-color:rgba(0,229,255,.65);box-shadow:0 0 18px rgba(0,229,255,.12)}

        .messages{
            position:relative;flex:1;overflow:auto;padding:18px;display:flex;flex-direction:column;gap:14px;
            scrollbar-gutter: stable both-edges;
            overscroll-behavior: contain;
            scrollbar-width: thin;
            scrollbar-color: rgba(0,229,255,.6) transparent;
        }
        .messages::-webkit-scrollbar{width:10px}
        .messages::-webkit-scrollbar-thumb{border-radius:8px;background:linear-gradient(180deg, rgba(0,229,255,.5), rgba(139,92,246,.5));border:2px solid transparent;background-clip:padding-box}

        .msg-line{display:flex;align-items:flex-end;gap:10px}
        .msg-line.user{justify-content:flex-end}
        .msg-avatar{width:30px;height:30px;border-radius:10px;flex:0 0 30px;object-fit:cover;box-shadow:0 6px 16px rgba(0,229,255,.25)}

        .msg{
            max-width:72%;padding:12px 14px;border-radius:14px;line-height:1.35;
            border:1px solid rgba(0,229,255,.18);
            box-shadow:0 12px 28px rgba(0,0,0,.20), inset 0 0 0 1px rgba(255,255,255,.06);
            font-size:15px;background:linear-gradient(180deg, rgba(0,229,255,.08), rgba(139,92,246,.08));
            backdrop-filter:blur(2px) saturate(120%);transition:transform var(--t-fast), box-shadow var(--t-fast)
        }
        .msg:hover{transform:translateY(-1px);box-shadow:0 16px 32px rgba(0,0,0,.22)}
        .msg.bot{color:#eaf7ff}
        .msg.user{background:linear-gradient(180deg, rgba(181,255,63,.18), rgba(0,229,255,.12));border-color:rgba(181,255,63,.40);color:#eafff6;box-shadow:0 10px 24px rgba(0,0,0,.18), 0 0 0 1px rgba(255,255,255,.05) inset}
        body.light .msg{
            background:#ffffff;
            border-color:rgba(0,0,0,.08);
            box-shadow:0 8px 16px rgba(0,0,0,.05);
            color:#0D0D0D;
            backdrop-filter:none;
        }
        body.light .msg.user{
            background:#ffffff;
            border-color:rgba(0,0,0,.10);
            color:#0b1535;
        }

        .composer{display:flex;gap:8px;position:sticky;bottom:0;padding:12px;background:#040a20;border-top:1px solid rgba(0,229,255,.25);box-shadow:0 -10px 28px rgba(0,0,0,.35)}
        body.light .composer{background:#ffffff;border-top:1px solid rgba(0,229,255,.45);box-shadow:0 -8px 18px rgba(0,0,0,.08)}
        .composer input{flex:1;padding:12px 14px;border-radius:12px;border:1px solid rgba(0,229,255,.35);outline:none;font-size:15px;background:rgba(4,10,30,.55);color:#e9f7ff;box-shadow:0 0 0 2px transparent;transition:box-shadow var(--t-fast), border-color var(--t-fast)}
        .composer input:focus{border-color:rgba(255,71,255,.65);box-shadow:0 0 0 2px rgba(255,71,255,.35), 0 0 22px rgba(255,71,255,.18)}
        body.light .composer input{background:#fff;border-color:rgba(0,229,255,.55);color:#0D0D0D}
        .composer button{padding:10px 14px;border-radius:12px;border:0;cursor:pointer;font-weight:900;font-size:14px;background:linear-gradient(135deg, var(--brand-from), var(--brand-to));color:#051025;box-shadow:0 10px 24px rgba(0,229,255,.35), 0 0 0 1px rgba(255,255,255,.12) inset;transition:filter var(--t-fast), transform var(--t-fast)}
        .composer button:hover{filter:brightness(1.05)}
        .composer input[disabled], .composer button[disabled]{opacity:.6;cursor:not-allowed}

        /* Gate */
        .overlay{position:fixed;inset:0;background:rgba(3,6,19,.75);backdrop-filter:blur(6px) saturate(130%);display:flex;align-items:center;justify-content:center;z-index:10}
        .hidden{display:none!important}
        .card{
            width:min(620px,92vw);
            background:radial-gradient(1000px 700px at 50% -200px, rgba(0,229,255,.16), transparent 55%),linear-gradient(180deg, rgba(8,12,35,.98), rgba(5,10,28,.98));
            color:#eaffff;border:1px solid rgba(0,229,255,.35);
            border-radius:22px;box-shadow:0 20px 60px rgba(0,0,0,.45), 0 0 48px rgba(255,71,255,.16);
            padding:20px;transition:transform var(--t-fast) ease;
        }
        body.light .card{background:#ffffff;color:#0D0D0D;border-color:rgba(0,229,255,.45);box-shadow:0 12px 40px rgba(0,0,0,.10), 0 0 40px rgba(0,229,255,.12)}
        .card h1{margin:0 0 8px;text-align:center;font-size:22px;letter-spacing:.4px}
        .card p{margin:0 0 4px;text-align:center;opacity:.92}
        .hero{display:flex;flex-direction:column;align-items:center;gap:12px;margin:8px 0 12px;text-align:center}
        .hero img{width:120px;height:120px;border-radius:50%;object-fit:cover;box-shadow:0 10px 30px rgba(0,229,255,.35), 0 0 0 2px rgba(255,255,255,.18) inset;border:2px solid rgba(0,229,255,.35)}
        .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px}
        .grid .full{grid-column:1/-1}
        label{font-size:13px;opacity:.95}
        select,input[type="text"],input[type="number"]{width:100%;padding:11px;border-radius:12px;border:1px solid rgba(0,229,255,.35);outline:none;font-size:14px;background:rgba(6,12,34,.65);color:#eaffff;box-shadow:0 0 0 2px transparent;transition:box-shadow var(--t-fast), border-color var(--t-fast)}
        select:focus,input[type="text"]:focus,input[type="number"]:focus{border-color:rgba(255,71,255,.65);box-shadow:0 0 0 2px rgba(255,71,255,.35), 0 0 22px rgba(255,71,255,.18)}
        body.light select, body.light input{background:#fff;color:#0D0D0D;border-color:rgba(0,229,255,.55)}
        .actions{display:flex;justify-content:flex-end;gap:10px;margin-top:14px}
        .primary{position:relative;display:inline-flex;align-items:center;gap:10px;background:linear-gradient(135deg,var(--brand-from),var(--brand-to));color:#051025;border:0;padding:10px 14px;border-radius:14px;font-weight:900;letter-spacing:.35px;box-shadow:0 12px 28px rgba(0,229,255,.45), 0 0 0 1px rgba(255,255,255,.10) inset;font-size:14px;transition:transform var(--t-fast), filter var(--t-fast)}
        .primary:active{transform:translateY(1px)}
        .err{margin-top:10px;padding:10px;border-radius:12px;border:1px solid rgba(255,0,0,.35);background:rgba(255,0,0,.10);color:#ffdede}
        .mini{font-size:12px;opacity:.85;margin-top:6px;text-align:center}

        /* Modal Perfil */
        .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:20}
        .modal::before{content:"";position:absolute;inset:0;background:rgba(3,6,19,.55);backdrop-filter:blur(8px) saturate(130%)}
        .modal-box{position:relative;z-index:1;width:min(720px,94vw);max-height:88vh;overflow:auto;border-radius:20px;padding:18px;background:linear-gradient(180deg, rgba(8,12,35,.98), rgba(5,10,28,.98));color:#eaffff;border:1px solid rgba(0,229,255,.35);box-shadow:0 20px 60px rgba(0,0,0,.45), 0 0 40px rgba(0,229,255,.20)}
        body.light .modal-box{background:#fff;color:#0D0D0D;border-color:rgba(0,229,255,.45);box-shadow:0 16px 40px rgba(0,0,0,.12), 0 0 36px rgba(0,229,255,.12)}
        .modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
        .modal-head h3{margin:0;font-size:18px}
        .modal-close{border:0;border-radius:12px;padding:6px 10px;cursor:pointer}
        .form{display:flex;flex-direction:column;gap:12px}
        .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        .row .full{grid-column:1/-1}
        .label{font-size:12px;opacity:.9;margin-bottom:4px}
        .field{padding:11px;border-radius:12px;border:1px solid rgba(0,229,255,.35);background:rgba(6,12,34,.65);color:#eaffff;outline:none}
        .field:focus{border-color:rgba(255,71,255,.65);box-shadow:0 0 0 2px rgba(255,71,255,.35), 0 0 22px rgba(255,71,255,.18)}
        body.light .field{background:#fff;border-color:rgba(0,229,255,.55)}
        .actions-right{display:flex;gap:10px;justify-content:flex-end;margin-top:8px}
        .btn-primary{padding:10px 13px;border-radius:12px;border:0;background:linear-gradient(135deg,var(--brand-from),var(--brand-to));color:#051025;cursor:pointer;font-weight:900;box-shadow:0 10px 24px rgba(0,229,255,.45), 0 0 0 1px rgba(255,255,255,.10) inset;font-size:14px}
        .btn-ghost{padding:10px 13px;border-radius:12px;border:1px solid rgba(0,229,255,.45);background:transparent;color:inherit;cursor:pointer;font-size:14px}
        .avatar-editor{display:flex;align-items:center;gap:14px}
        .avatar-editor img{width:72px;height:72px;border-radius:50%;object-fit:cover;box-shadow:0 8px 22px rgba(0,229,255,.35), 0 0 0 2px rgba(255,255,255,.12) inset;border:2px solid rgba(0,229,255,.35)}

        /* Notas: altura fija 5cm */
        #notesArea{
            height:5cm; min-height:5cm; max-height:5cm;
            resize:none; overflow:auto;
        }
    </style>
</head>
<body class="dark">
<div id="app" class="wrap">

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="brand">
            <img id="brandLogo" src="./images/0e19878d6dfb3d04113241d8f79fc4c3.jpg" alt="BIO SPACE AI">
            <div class="title">BIO SPACE AI</div>
        </div>

        <div class="section">
            <button id="btnNewChat" class="btn">âž•</button>
        </div>

        <div class="section">
            <h3 id="lblNotes">Notes</h3>
            <div class="card-min">
                <div class="row">
                    <textarea id="notesArea" rows="6" placeholder="Write a note..."></textarea>
                </div>
                <div class="mini" id="notesHint">Auto-saved in this browser.</div>
            </div>
        </div>

        <!-- Controles en fila -->
        <div class="section controls">
            <button id="btnTheme" class="toggle icon-only" aria-label="Theme">ðŸŒ“ <span id="lblTheme" aria-hidden="true"></span></button>
            <button id="btnLang" class="toggle icon-only" aria-label="Language">ðŸ‡ºðŸ‡¸</button>
            <button id="btnReset" class="toggle icon-only" aria-label="Reset data">âŸ³</button>
        </div>

        <div class="footer">
            <div class="who">
                <div style="display:flex;align-items:center;gap:10px">
                    <div class="avatar" id="avatar"><span id="avatarInitial" style="display: block;">L</span><img id="avatarImg" alt="Avatar" style="display: none;"></div>
                    <div>
                        <div class="name" id="whoName">li</div>
                        <div class="role" id="whoRole">Teacher â€¢ 19</div>
                    </div>
                </div>
                <div class="profile-actions">
                    <button id="editProfile" class="btn small ghost" aria-label="Edit profile">âœŽ</button>
                </div>
            </div>
        </div>
    </aside>

    <!-- Chat -->
    <main class="chat">
        <div id="spaceBg" class="space-bg" style="background-image: url('https://wallpapers.com/images/hd/blue-nebula-wallpaper-4k-hd-free-for-desktop-acyfly54avxdmy0g.webp');"></div>
        <header class="chat-header">
            <div class="logo">
                <img id="botLogo" src="./images/2eedc9ea419d830e6dd26b74ee0e6436.jpg" alt="Mascot">
                <div class="title">Quetzalito</div>
                <div class="ia-badge">AI</div>
            </div>
        </header>

        <section id="messages" class="messages"></section>

        <div class="composer">
            <input id="inputMsg" type="text" autocomplete="off" placeholder="Type your messageâ€¦">
            <button id="btnSend" class="send" aria-label="Send">â®ž</button>
        </div>
    </main>
</div>

<!-- Gate -->
<div id="dlg" class="overlay hidden">
    <div class="card" id="gateCard" style="transform: scale(1);">
        <div class="hero">
            <img src="./images/0e19878d6dfb3d04113241d8f79fc4c3.jpg" alt="BIO SPACE AI">
            <h1 id="gateTitle">WELCOME TO BIO SPACE AI</h1>
            <p id="gateSubtitle">Fill in your info to enter the chat.</p>
        </div>

        <div class="grid">
            <div class="full">
                <label for="rol" id="lblRole">Role</label>
                <select id="rol" required>
                    <option value="" disabled selected id="optSelectRole">Choose a roleâ€¦</option>
                    <option value="Student" id="optStudent">Student</option>
                    <option value="Teacher" id="optTeacher">Teacher</option>
                    <option value="Expert" id="optExpert">Expert</option>
                </select>
            </div>
            <div>
                <label for="nombre" id="lblName">Name</label>
                <input id="nombre" type="text" placeholder="Your name" required>
            </div>
            <div>
                <label for="edad" id="lblAge">Age</label>
                <input id="edad" type="number" min="1" max="120" placeholder="18" required>
            </div>

            <div class="full" style="display:flex;align-items:center;gap:10px;margin-top:4px">
                <input id="noRemember" type="checkbox">
                <label for="noRemember" style="user-select:none;cursor:pointer">
                    Do not remember my data <span style="opacity:.8">(this session only)</span>
                </label>
            </div>
        </div>

        <div class="actions">
            <button id="okDlg" class="primary"><span id="lblStart">Start â–¶</span></button>
        </div>
        <div id="formError" class="err" style="display:none;"></div>
        <div class="mini" id="gateNote">Your data is stored locally for this session.</div>
    </div>
</div>

<!-- Profile Modal -->
<section id="profileModal" class="modal" aria-hidden="true" style="display:none;">
    <div class="modal-box">
        <div class="modal-head">
            <h3 id="editTitle">Edit profile</h3>
            <button id="closeProfile" class="modal-close" aria-label="Close">âœ•</button>
        </div>
        <form id="profileForm" class="form" novalidate>
            <div class="row">
                <div>
                    <div class="label" id="lblRoleEdit">Role</div>
                    <select id="pRole" class="field" required>
                        <option value="Student" id="optStudent2">Student</option>
                        <option value="Teacher" id="optTeacher2">Teacher</option>
                        <option value="Expert" id="optExpert2">Expert</option>
                    </select>
                </div>
                <div>
                    <div class="label" id="lblAgeEdit">Age</div>
                    <input id="pAge" class="field" type="number" min="1" max="120" required>
                </div>
                <div class="full">
                    <div class="label" id="lblNameEdit">Name</div>
                    <input id="pName" class="field" type="text" minlength="2" placeholder="Your name" required>
                </div>
                <div class="full avatar-editor">
                    <img id="pAvatar" alt="Avatar" src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='72' height='72'><rect width='100%' height='100%' fill='%23ddd'/></svg>">
                    <div>
                        <div class="label" id="lblPhoto">Profile photo</div>
                        <input id="pFile" type="file" accept="image/*" class="field">
                        <div class="mini" id="lblCropNote">It is automatically cropped to a circle.</div>
                    </div>
                </div>
            </div>
            <div class="actions-right">
                <button type="button" class="btn-ghost" id="cancelEdit"><span id="lblCancel">Cancel</span></button>
                <button type="submit" class="btn-primary"><span id="lblSave">Save changes</span></button>
            </div>
        </form>
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        if (location.search.includes('fresh=1') || location.hash === '#reset') {
            try { sessionStorage.clear(); localStorage.clear(); } catch {}
        }

        const BOT_AVATAR = 'https://i.pinimg.com/736x/2e/ed/c9/2eedc9ea419d830e6dd26b74ee0e6436.jpg';

        const els = {
            body: document.body,
            brandLogo: document.getElementById('brandLogo'),
            spaceBg: document.getElementById('spaceBg'),
            messages: document.getElementById('messages'),
            input: document.getElementById('inputMsg'),
            btnSend: document.getElementById('btnSend'),
            btnNew: document.getElementById('btnNewChat'),
            btnTheme: document.getElementById('btnTheme'),
            btnLang: document.getElementById('btnLang'),
            btnReset: document.getElementById('btnReset'),
            whoName: document.getElementById('whoName'),
            whoRole: document.getElementById('whoRole'),
            avatarInitial: document.getElementById('avatarInitial'),
            avatarImg: document.getElementById('avatarImg'),
            dlg: document.getElementById('dlg'),
            okDlg: document.getElementById('okDlg'),
            rol: document.getElementById('rol'),
            nombre: document.getElementById('nombre'),
            edad: document.getElementById('edad'),
            noRemember: document.getElementById('noRemember'),
            editProfile: document.getElementById('editProfile'),
            formError: document.getElementById('formError'),
            profileModal: document.getElementById('profileModal'),
            closeProfile: document.getElementById('closeProfile'),
            cancelEdit: document.getElementById('cancelEdit'),
            profileForm: document.getElementById('profileForm'),
            pRole: document.getElementById('pRole'),
            pName: document.getElementById('pName'),
            pAge: document.getElementById('pAge'),
            pFile: document.getElementById('pFile'),
            pAvatar: document.getElementById('pAvatar'),
            notes: document.getElementById('notesArea'),
            notesHint: document.getElementById('notesHint'),
            gateCard: document.getElementById('gateCard'),
        };

        const LANG_KEY = 'q_lang';
        const i18n = {
            en: {
                newChat:'New chat', themeDark:'Theme: Dark', themeLight:'Theme: Light', lang:'EN',
                send:'Send', composerPH:'Type your messageâ€¦',
                gateTitle:'WELCOME TO BIO SPACE AI', gateSubtitle:'Fill in your info to enter the chat.',
                role:'Role', name:'Name', age:'Age', selectRole:'Choose a roleâ€¦',
                student:'Student', teacher:'Teacher', expert:'Expert',
                start:'Start â–¶', gateNote:'Your data is stored locally for this session.', formError:'Please fill role, name and age.',
                greet:(n)=>`Hi, <b>${n}</b>. Ready to explore space?`,
                updated:'Profile updated. âœ…', edit:'Edit',
                editTitle:'Edit profile', save:'Save changes', cancel:'Cancel', photo:'Profile photo', cropNote:'It is automatically cropped to a circle.',
                newChatStarted:'New chat started.', gotIt:'Got it. Thinkingâ€¦', fillFirst:'Complete the form to enterâ€¦',
                notes:'Notes', notePH:'Write a note...', noteHint:'Auto-saved in this browser.'
            },
            es: {
                newChat:'Nuevo chat', themeDark:'Tema: Oscuro', themeLight:'Tema: Claro', lang:'ES',
                send:'Enviar', composerPH:'Escribe tu consultaâ€¦',
                gateTitle:'BIENVENIDO A BIO SPACE IA', gateSubtitle:'Completa tus datos para ingresar al chat.',
                role:'Rol', name:'Nombre', age:'Edad', selectRole:'Selecciona un rolâ€¦',
                student:'Estudiante', teacher:'Docente', expert:'Experto',
                start:'Empezar â–¶', gateNote:'Tus datos se guardan localmente para esta sesiÃ³n.', formError:'Completa rol, nombre y edad.',
                greet:(n)=>`Hola, <b>${n}</b>. Â¿Listo para explorar el espacio?`,
                updated:'Perfil actualizado. âœ…', edit:'Editar',
                editTitle:'Editar perfil', save:'Guardar cambios', cancel:'Cancelar', photo:'Foto de perfil', cropNote:'Se recorta en cÃ­rculo automÃ¡ticamente.',
                newChatStarted:'Nuevo chat iniciado.', gotIt:'Recibido. Estoy pensandoâ€¦', fillFirst:'Completa el formulario para ingresarâ€¦',
                notes:'Notas', notePH:'Escribe una nota...', noteHint:'Se guarda automÃ¡ticamente en este navegador.'
            }
        };
        let lang = localStorage.getItem(LANG_KEY) || 'en';

        const AVATAR_KEY = 'q_avatar';
        const USER_KEY = 'q_user';
        const THEME_KEY = 'q_theme';
        const NOTES_KEY = 'q_notes';
        const STORAGE_MODE_KEY = 'remember_mode';
        const USER_TTL_DAYS = 7;

        const state = {
            theme: localStorage.getItem(THEME_KEY) || 'dark',
            user: { nombre: '', rol: '', edad: '' }
        };

        const LOGO_DARK = 'https://i.pinimg.com/736x/0e/19/87/0e19878d6dfb3d04113241d8f79fc4c3.jpg';
        const LOGO_LIGHT = 'https://i.pinimg.com/736x/55/2f/c9/552fc9de128eb8d8829ebd90179ea535.jpg';
        function updateBrandLogo(){ els.brandLogo.src = document.body.classList.contains('dark') ? LOGO_DARK : LOGO_LIGHT; }

        function setBackground(){
            const darkUrl = 'https://wallpapers.com/images/hd/blue-nebula-wallpaper-4k-hd-free-for-desktop-acyfly54avxdmy0g.webp';
            if (state.theme === 'dark') {
                els.spaceBg.style.backgroundImage = `url('${darkUrl}')`;
            } else {
                els.spaceBg.style.backgroundImage = 'none'; // sin imagen en modo claro
            }
        }
        function applyTheme(){
            document.body.classList.toggle('dark', state.theme==='dark');
            document.body.classList.toggle('light', state.theme==='light');
            setBackground(); updateBrandLogo();
        }
        applyTheme();

        function applyLang(){
            const tr = i18n[lang];
            document.getElementById('lblNotes').textContent = tr.notes;
            els.notes.placeholder = tr.notePH;
            els.notesHint.textContent = tr.noteHint;

            document.getElementById('gateTitle').textContent = tr.gateTitle;
            document.getElementById('gateSubtitle').textContent = tr.gateSubtitle;
            document.getElementById('lblRole').textContent = tr.role;
            document.getElementById('lblName').textContent = tr.name;
            document.getElementById('lblAge').textContent = tr.age;
            document.getElementById('optSelectRole').textContent = tr.selectRole;
            document.getElementById('optStudent').textContent = tr.student;
            document.getElementById('optTeacher').textContent = tr.teacher;
            document.getElementById('optExpert').textContent = tr.expert;
            document.getElementById('lblStart').textContent = tr.start;
            document.getElementById('gateNote').textContent = tr.gateNote;

            document.getElementById('editTitle').textContent = tr.editTitle;
            document.getElementById('lblRoleEdit').textContent = tr.role;
            document.getElementById('lblAgeEdit').textContent = tr.age;
            document.getElementById('lblNameEdit').textContent = tr.name;
            document.getElementById('optStudent2').textContent = tr.student;
            document.getElementById('optTeacher2').textContent = tr.teacher;
            document.getElementById('optExpert2').textContent = tr.expert;
            document.getElementById('lblPhoto').textContent = tr.photo;
            document.getElementById('lblCropNote').textContent = tr.cropNote;
            document.getElementById('lblCancel').textContent = tr.cancel;
            document.getElementById('lblSave').textContent = tr.save;

            if (els.input) els.input.placeholder = tr.composerPH;
            els.btnLang.textContent = (lang==='en') ? 'ðŸ‡ºðŸ‡¸' : 'ðŸ‡ªðŸ‡¸';
        }

        function nowTs(){ return Date.now(); }
        function addDays(ts, d){ return ts + d*24*60*60*1000; }
        function isExpired(meta){
            if(!USER_TTL_DAYS) return false;
            if(!meta || !meta.ts) return false;
            try{ return nowTs() > addDays(meta.ts, USER_TTL_DAYS); }catch{ return false; }
        }

        function setUserStorage(user, mode) {
            const payload = JSON.stringify(user);
            const meta = JSON.stringify({ ts: nowTs() });

            if (mode === 'session') {
                sessionStorage.setItem(USER_KEY, payload);
                sessionStorage.setItem(STORAGE_MODE_KEY, 'session');
                sessionStorage.setItem(USER_KEY + '_meta', meta);
                localStorage.removeItem(USER_KEY);
                localStorage.removeItem(STORAGE_MODE_KEY);
                localStorage.removeItem(USER_KEY + '_meta');
            } else {
                localStorage.setItem(USER_KEY, payload);
                localStorage.setItem(STORAGE_MODE_KEY, 'local');
                localStorage.setItem(USER_KEY + '_meta', meta);
                sessionStorage.removeItem(USER_KEY);
                sessionStorage.removeItem(STORAGE_MODE_KEY);
                sessionStorage.removeItem(USER_KEY + '_meta');
            }
        }

        function getUserStorage() {
            let mode = sessionStorage.getItem(STORAGE_MODE_KEY) ? 'session'
                : localStorage.getItem(STORAGE_MODE_KEY) ? 'local' : null;

            let raw=null, meta=null;

            if (mode === 'session') {
                raw = sessionStorage.getItem(USER_KEY);
                meta = sessionStorage.getItem(USER_KEY + '_meta');
            } else if (mode === 'local') {
                raw = localStorage.getItem(USER_KEY);
                meta = localStorage.getItem(USER_KEY + '_meta');
            }

            if (!raw) {
                const sRaw = sessionStorage.getItem(USER_KEY);
                const lRaw = localStorage.getItem(USER_KEY);
                if (sRaw) { raw = sRaw; meta = sessionStorage.getItem(USER_KEY + '_meta'); mode = 'session'; }
                else if (lRaw) { raw = lRaw; meta = localStorage.getItem(USER_KEY + '_meta'); mode = 'local'; }
            }

            try {
                const user = raw ? JSON.parse(raw) : null;
                const m = meta ? JSON.parse(meta) : null;
                if (isExpired(m)) { clearUserStorage(); return { user:null, mode:null }; }
                return { user, mode };
            } catch {
                return { user:null, mode:null };
            }
        }

        function clearUserStorage() {
            sessionStorage.removeItem(USER_KEY);
            sessionStorage.removeItem(USER_KEY + '_meta');
            sessionStorage.removeItem(STORAGE_MODE_KEY);

            localStorage.removeItem(USER_KEY);
            localStorage.removeItem(USER_KEY + '_meta');
            localStorage.removeItem(STORAGE_MODE_KEY);
        }

        function getAvatarAny(){
            return sessionStorage.getItem(AVATAR_KEY)
                || localStorage.getItem(AVATAR_KEY) || '';
        }
        function setAvatarByMode(dataUrl, mode){
            if(mode==='session'){
                sessionStorage.setItem(AVATAR_KEY, dataUrl);
                localStorage.removeItem(AVATAR_KEY);
            } else {
                localStorage.setItem(AVATAR_KEY, dataUrl);
                sessionStorage.removeItem(AVATAR_KEY);
            }
        }

        function disableComposer(){ els.input.value=''; els.input.disabled=true; els.btnSend.disabled=true; els.input.placeholder = i18n[lang].fillFirst; }
        function enableComposer(){ els.input.disabled=false; els.btnSend.disabled=false; els.input.placeholder=i18n[lang].composerPH; els.input.focus(); }

        function makeLine(who, html){
            const line = document.createElement('div'); line.className = `msg-line ${who}`;
            if(who==='bot'){
                const img = document.createElement('img');
                img.className = 'msg-avatar'; img.src = BOT_AVATAR; img.alt = 'Quetzalito';
                line.appendChild(img);
            }
            const bubble = document.createElement('div'); bubble.className = `msg ${who}`; bubble.innerHTML = html; line.appendChild(bubble);
            return line;
        }
        function addMsg(text, who='bot'){
            const line = makeLine(who, text);
            els.messages.appendChild(line);
            requestAnimationFrame(()=>{
                els.messages.scrollTo({ top: els.messages.scrollHeight, behavior: 'smooth' });
            });
        }

        function renderAvatar(){
            const data = getAvatarAny();
            if(data){ els.avatarImg.src = data; els.avatarImg.style.display = 'block'; els.avatarInitial.style.display = 'none'; }
            else{ els.avatarImg.style.display = 'none'; els.avatarInitial.style.display = 'block'; els.avatarInitial.textContent = (state.user.nombre||'?').trim().charAt(0).toUpperCase(); }
        }

        function saveUser(){
            els.whoName.textContent = state.user.nombre || 'â€”';
            els.whoRole.textContent = state.user.rol ? `${state.user.rol} â€¢ ${state.user.edad}` : 'â€”';
            renderAvatar();
        }

        function loadUser(){
            const { user } = getUserStorage();
            if (user) {
                els.nombre.value = user.nombre || '';
                els.edad.value   = user.edad   || '';
                els.rol.value    = user.rol    || '';
                state.user = user;
            }
            document.body.classList.add('locked');
            disableComposer();
            els.dlg.classList.remove('hidden');
            els.nombre.focus();
        }

        try{ els.notes.value = localStorage.getItem(NOTES_KEY) || ''; }catch{}
        els.notes.addEventListener('input', ()=>{ try{ localStorage.setItem(NOTES_KEY, els.notes.value); }catch{} });

        // Enviar
        els.btnSend.addEventListener('click', ()=>{
            if(!state.user || !state.user.nombre){
                document.body.classList.add('locked'); disableComposer();
                els.dlg.classList.remove('hidden'); els.nombre.focus(); return;
            }
            const txt = (els.input.value||'').trim(); if(!txt) return;
            addMsg(txt,'user'); els.input.value='';
            setTimeout(()=> addMsg(i18n[lang].gotIt || 'Got it. Thinkingâ€¦'),200);
        });
        els.input.addEventListener('keydown', (e)=>{ if(e.key==='Enter') els.btnSend.click(); });

        // MantÃ©n scroll al escribir si estÃ¡s cerca del fondo
        els.input.addEventListener('input', ()=>{
            const nearBottom = (els.messages.scrollHeight - els.messages.clientHeight - els.messages.scrollTop) < 40;
            if (nearBottom) els.messages.scrollTop = els.messages.scrollHeight;
        });

        // Nuevo chat limpia sin mensaje extra
        els.btnNew.addEventListener('click', ()=>{ els.messages.innerHTML=''; });

        els.btnTheme.addEventListener('click', ()=>{
            state.theme = state.theme==='dark'?'light':'dark';
            try{ localStorage.setItem(THEME_KEY, state.theme); }catch{}
            applyTheme();
        });

        els.btnLang.addEventListener('click', ()=>{
            lang = (lang==='en') ? 'es' : 'en';
            try{ localStorage.setItem(LANG_KEY, lang); }catch{}
            applyLang();
        });

        els.btnReset.addEventListener('click', ()=>{
            clearUserStorage();
            sessionStorage.removeItem(AVATAR_KEY);
            localStorage.removeItem(AVATAR_KEY);

            state.user = { nombre:'', edad:'', rol:'' };
            els.messages.innerHTML='';
            document.body.classList.add('locked');
            disableComposer();
            els.dlg.classList.remove('hidden');
            els.nombre.value=''; els.edad.value=''; els.rol.value='';
            els.noRemember.checked = false;
            els.nombre.focus();
        });

        function showError(msg){ els.formError.style.display='block'; els.formError.textContent = msg; }
        function clearError(){ els.formError.style.display='none'; els.formError.textContent=''; }

        // Cerrar gate y dejar chat vacÃ­o listo
        function closeGate(){
            els.gateCard.style.transform='scale(.985)'; setTimeout(()=>{ els.gateCard.style.transform='scale(1)'; }, 110);
            els.dlg.classList.add('hidden'); document.body.classList.remove('locked');
            els.messages.innerHTML=''; enableComposer();
        }

        els.okDlg.addEventListener('click', ()=>{
            const nombre=(els.nombre.value||'').trim();
            const edad=(els.edad.value||'').trim();
            const rol=els.rol.value||'';
            if(!nombre || !edad || !rol){ showError(i18n[lang].formError); return; }
            clearError();

            state.user={nombre,edad,rol};

            const mode = els.noRemember.checked ? 'session' : 'local';
            setUserStorage(state.user, mode);
            saveUser();
            closeGate();
        });

        ['nombre','edad','rol'].forEach(id=>{
            document.getElementById(id).addEventListener('keydown', (e)=>{
                if(e.key==='Enter'){ e.preventDefault(); els.okDlg.click(); }
            });
        });

        // Modal perfil
        function openProfileModal(){
            els.pRole.value = state.user.rol || 'Student';
            els.pName.value = state.user.nombre || '';
            els.pAge.value  = state.user.edad || '';
            const avatarData = getAvatarAny();
            els.pAvatar.src = avatarData || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="72" height="72"><rect width="100%" height="100%" fill="%23ddd"/></svg>';
            els.profileModal.style.display = 'flex';
        }
        function closeProfileModal(){ els.profileModal.style.display='none'; }

        els.pFile.addEventListener('change', (e)=>{
            const f = e.target.files && e.target.files[0]; if(!f || !f.type.startsWith('image/')) return;
            const url = URL.createObjectURL(f); const im = new Image();
            im.onload = () => {
                const S = 256; const c = document.createElement('canvas'); c.width=S; c.height=S; const ctx = c.getContext('2d');
                ctx.beginPath(); ctx.arc(S/2,S/2,S/2,0,Math.PI*2); ctx.closePath(); ctx.clip();
                const r = Math.max(S/im.width, S/im.height); const w = im.width*r, h = im.height*r;
                ctx.drawImage(im, (S-w)/2, (S-h)/2, w, h);
                const d = c.toDataURL('image/png');
                const currentMode = sessionStorage.getItem(STORAGE_MODE_KEY) ? 'session' : 'local';
                setAvatarByMode(d, currentMode);
                els.pAvatar.src = d; renderAvatar();
            }; im.src = url;
        });

        els.profileForm.addEventListener('submit', (ev)=>{
            ev.preventDefault();
            if(!els.pName.value.trim() || !els.pAge.value) return;
            state.user = { nombre: els.pName.value.trim(), edad: els.pAge.value, rol: els.pRole.value || 'Student' };
            const currentMode = sessionStorage.getItem(STORAGE_MODE_KEY) ? 'session' : 'local';
            setUserStorage(state.user, currentMode);
            saveUser(); closeProfileModal(); addMsg(i18n[lang].updated, 'bot');
        });

        els.editProfile.addEventListener('click', openProfileModal);
        els.closeProfile.addEventListener('click', closeProfileModal);
        els.cancelEdit.addEventListener('click', closeProfileModal);
        window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeProfileModal(); });

        // INIT
        applyLang(); applyTheme(); renderAvatar(); loadUser();
    });
</script>

</body>
</html>